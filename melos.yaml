name: powersync_dart

packages:
  - packages/*
  - demos/*
  - demos/*/*

ide:
  intellij: false

scripts:
  prepare: melos bootstrap && melos compile:webworker && melos update:wasm

  format:
    description: Format Dart code.
    run: dart format .

  format:check:packages:
    description: Check formatting of Dart code in packages.
    run: dart format --output none --set-exit-if-changed packages

  format:check:demos:
    description: Check formatting of Dart code in demos.
    run: dart format --output none --set-exit-if-changed demos

  analyze:packages:
    description: Analyze Dart code in packages.
    run: dart analyze packages --fatal-infos

  analyze:demos:
    description: Analyze Dart code in demos.
    run: dart analyze demos --fatal-infos

  compile:webworker:
    description: Compile Javascript web worker distributable
    exec: dart run powersync_web_worker:compile_webworker
    packageFilters:
      scope:
        - powersync_web_worker

  update:wasm: sh scripts/init_sqlite_wasm.sh

  test:
    description: Run tests in a specific package.
    # Tests on Web are disabled for now. They pass locally but there is a network issue on CI
    run: dart test -p vm,chrome
    exec:
      concurrency: 1
    packageFilters:
      dirExists:
        - test
    # This tells Melos tests to ignore env variables passed to tests from `melos run test`
    # as they could change the behaviour of how tests filter packages.
    env:
      MELOS_TEST: true
